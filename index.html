  const render = () => {
    sum1El.textContent = sum1;
    sum2El.textContent = sum2;
    sumAllEl.textContent = sum1 + sum2;
    totalEventsEl.textContent = events.length;
    
    // Update mobile count displays
    mobileSum1.textContent = sum1;
    mobileSum2.textContent = sum2;
    
    const startDate = new Date(startAt);
    const pad = (n) => String(n).padStart(2, '0');
    startAtEl.textContent = `${pad(startDate.getHours())}:${pad(startDate.getMinutes())}`;

    label1.textContent = name1.value || '方向1';
    label2.textContent = name2.value || '方向2';

    // Recent 10 events
    const last = events.slice(-10).reverse();
    const renderTable = (targetTbody) => {
      targetTbody.innerHTML = '';
      last.forEach((ev, idx) => {
        const tr = document.createElement('tr');
        const dirLabel = ev.dir === 1 ? 
          `<span class="pill d1">${name1.value || '方向1'}</span>` : 
          `<span class="pill d2">${name2.value || '方向2'}</span>`;
        
        tr.innerHTML = `
          <td class="right">${events.length - idx}</td>
          <td>${formatTime(ev.tsISO)}</td>
          <td>${dirLabel}</td>
          <td class="right">${ev.sum1 + ev.sum2}</td>
        `;
        targetTbody.appendChild(tr);
      });
    };
    
    renderTable(tbody);
    render<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0f172a" />
<meta name="description" content="2方向の人流をカウントするPWAアプリ。オフラインでも動作します。" />

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json" />

<!-- iOS用アイコン -->
<link rel="apple-touch-icon" href="icon-192.png" />

<title>人流カウンター PWA</title>

<style>
  :root { 
    --bg:#0f172a; 
    --card:#111827; 
    --ink:#e5e7eb; 
    --muted:#94a3b8; 
    --accent:#22c55e; 
    --danger:#ef4444; 
    --warn:#f59e0b;
    --primary:#2563eb;
    --secondary:#16a34a;
  }
  
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  
  html, body {
    height: 100%;
    overflow-x: hidden;
  }
  
  body {
    margin: 0; 
    background: var(--bg); 
    color: var(--ink); 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
    touch-action: manipulation;
  }
  
  .wrap {
    max-width: 980px;
    margin: 0 auto;
    padding: 16px;
  }
  
  h1 {
    font-size: 20px;
    margin: 0 0 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .pwa-badge {
    background: var(--accent);
    color: white;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
  }
  
  .sub {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 12px;
  }
  
  .card {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(0,0,0,.3);
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 24px 16px;
    border: none;
    border-radius: 16px;
    font-size: 24px;
    font-weight: 800;
    cursor: pointer;
    user-select: none;
    transition: transform .02s ease-in-out, opacity .2s;
    -webkit-user-select: none;
  }
  
  .btn:active:not(:disabled) {
    transform: scale(.98);
  }
  
  .btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .btn-dir1 {
    background: var(--primary); 
    color: white;
  }
  
  .btn-dir2 {
    background: var(--secondary); 
    color: white;
  }
  
  .btn-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 12px;
  }
  
  .stat {
    background: #0b1220;
    border: 1px solid #283249;
    border-radius: 12px;
    padding: 10px;
    text-align: center;
  }
  
  .stat .label {
    font-size: 11px;
    color: #93a4bd;
  }
  
  .stat .val {
    font-size: 20px;
    font-weight: 700;
    margin-top: 2px;
  }
  
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  
  .small {
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid #334155;
    background: #0b1220;
    color: #e5e7eb;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    flex: 1;
    min-width: 80px;
    text-align: center;
  }
  
  .small:active {
    transform: scale(.95);
  }
  
  .small.warn {
    border-color: #a16207;
    color: var(--warn);
  }
  
  .small.danger {
    border-color: #7f1d1d;
    color: var(--danger);
  }
  
  .small.primary {
    border-color: #1d4ed8;
    color: #60a5fa;
  }
  
  .small.lock-active {
    background: var(--danger);
    border-color: var(--danger);
    color: white;
  }
  
  input[type="text"], select {
    background: #0b1220;
    border: 1px solid #334155;
    border-radius: 10px;
    color: #e5e7eb;
    padding: 10px;
    width: 100%;
    font-size: 14px;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }
  
  .input-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .input-row label {
    display: flex;
    align-items: center;
    gap: 4px;
    flex: 1;
    font-size: 13px;
    color: var(--muted);
  }
  
  .input-row input, .input-row select {
    flex: 2;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
  }
  
  th, td {
    border-bottom: 1px solid #223046;
    padding: 6px 4px;
    text-align: left;
  }
  
  th {
    color: #9fb0c9;
    font-weight: 700;
    font-size: 11px;
  }
  
  .right {
    text-align: right;
  }
  
  .pill {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 10px;
  }
  
  .pill.d1 {
    background: rgba(37,99,235,.18);
    color: #bfdbfe;
    border: 1px solid #3b82f6;
  }
  
  .pill.d2 {
    background: rgba(22,163,74,.18);
    color: #bbf7d0;
    border: 1px solid #22c55e;
  }
  
  .hint {
    font-size: 11px;
    color: #9fb0c9;
    margin-top: 6px;
  }
  
  .footer {
    margin-top: 18px;
    color: #7b8ea8;
    font-size: 11px;
    text-align: center;
  }
  
  /* Modal for CSV */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    padding: 16px;
    overflow-y: auto;
  }
  
  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .modal-close {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 700;
    cursor: pointer;
  }
  
  textarea {
    background: #0b1220;
    border: 1px solid #334155;
    border-radius: 10px;
    color: #e5e7eb;
    padding: 10px;
    width: 100%;
    min-height: 200px;
    font-family: monospace;
    font-size: 12px;
    resize: vertical;
  }
  
  .copy-btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
  }
  
  .lock-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(239, 68, 68, 0.1);
    z-index: 500;
    pointer-events: none;
  }
  
  .lock-overlay.show {
    display: block;
  }
  
  .lock-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--danger);
    color: white;
    padding: 16px 32px;
    border-radius: 16px;
    font-weight: 700;
    font-size: 18px;
    z-index: 501;
    display: none;
  }
  
  .lock-indicator.show {
    display: block;
  }
  
  /* PWA Install prompt */
  .install-prompt {
    display: none;
    background: var(--accent);
    color: white;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 16px;
    text-align: center;
  }
  
  .install-prompt.show {
    display: block;
  }
  
  .install-btn {
    background: white;
    color: var(--accent);
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 700;
    cursor: pointer;
    margin-left: 8px;
  }
  
  /* Offline indicator */
  .offline-indicator {
    display: none;
    background: var(--warn);
    color: white;
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
  }
  
  .offline-indicator.show {
    display: block;
  }
  
  /* Mobile specific styles */
  @media (max-width: 768px) {
    .wrap {
      padding: 12px;
    }
    
    h1 {
      font-size: 18px;
    }
    
    .btn-row {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .btn {
      padding: 50px 20px;
      font-size: 28px;
      min-height: 200px;
    }
    
    .stats {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }
    
    .small {
      min-width: auto;
    }
    
    .input-row {
      flex-direction: column;
      align-items: stretch;
    }
    
    .input-row label {
      margin-bottom: 4px;
    }
    
    /* Hide keyboard shortcuts on mobile */
    .kbd-hint {
      display: none;
    }
  }
  
  /* Desktop specific */
  @media (min-width: 769px) {
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .stats {
      grid-template-columns: repeat(4, 1fr);
    }
    
    .controls {
      flex-direction: row;
    }
    
    .small {
      flex: initial;
    }
  }
  
  /* PWA standalone mode adjustments */
  @media all and (display-mode: standalone) {
    .pwa-badge {
      display: inline-block;
    }
  }
  
  @media all and (display-mode: browser) {
    .pwa-badge {
      display: none;
    }
  }
</style>
</head>
<body>
  <div class="offline-indicator" id="offlineIndicator">
    オフラインモード - データは端末に保存されています
  </div>
  
  <div class="wrap">
    <div class="install-prompt" id="installPrompt">
      📱 アプリとしてインストールできます
      <button class="install-btn" id="installBtn">インストール</button>
    </div>
    
    <h1>
      2方向 人流カウンター
      <span class="pwa-badge">PWA</span>
    </h1>
    <div class="sub">タップで<b>時刻付き</b>カウント。オフラインでも動作します。</div>

    <div class="grid">
      <div class="card">
        <div class="input-group">
          <div class="input-row">
            <label>場所</label>
            <input id="note" type="text" placeholder="例: 東門前" />
          </div>
          <div class="input-row">
            <label>方向1</label>
            <input id="name1" type="text" value="上り" />
          </div>
          <div class="input-row">
            <label>方向2</label>
            <input id="name2" type="text" value="下り" />
          </div>
          <div class="input-row">
            <label>音</label>
            <select id="soundSel">
              <option value="off">オフ</option>
              <option value="beep">ビープ</option>
            </select>
          </div>
          <div class="input-row">
            <label>振動</label>
            <select id="vibrateSel">
              <option value="off">オフ</option>
              <option value="on">オン</option>
            </select>
          </div>
        </div>

        <div class="btn-row">
          <button id="btn1" class="btn btn-dir1">
            方向1（<span id="label1">上り</span>）
            <span class="kbd-hint">A/←</span>
          </button>
          <button id="btn2" class="btn btn-dir2">
            方向2（<span id="label2">下り</span>）
            <span class="kbd-hint">L/→</span>
          </button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="label">方向1 合計</div>
            <div class="val" id="sum1">0</div>
          </div>
          <div class="stat">
            <div class="label">方向2 合計</div>
            <div class="val" id="sum2">0</div>
          </div>
          <div class="stat">
            <div class="label">合計</div>
            <div class="val" id="sumAll">0</div>
          </div>
          <div class="stat">
            <div class="label">開始</div>
            <div class="val" id="startAt" style="font-size:14px">—</div>
          </div>
        </div>

        <div class="controls">
          <button class="small primary" id="exportCsv">CSV出力</button>
          <button class="small" id="undoBtn">取消</button>
          <button class="small" id="lockBtn">ロック</button>
          <button class="small warn" id="resetBtn">リセット</button>
          <button class="small" id="fullBtn">全画面</button>
        </div>
        
        <div class="hint">
          誤タップ防止のため「ロック」を使用してください。データは自動保存されます。
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <div style="font-weight:700; font-size:14px">直近イベント</div>
          <div class="hint">合計: <span id="totalEvents">0</span> 件</div>
        </div>
        <div style="overflow-x:auto">
          <table id="table">
            <thead>
              <tr>
                <th>#</th>
                <th>時刻</th>
                <th>方向</th>
                <th>累計</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      PWA版 - オフライン対応。ホーム画面に追加してアプリとして使用可能。
    </div>
  </div>

  <!-- CSV Modal -->
  <div id="csvModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>CSV出力</h3>
        <button class="modal-close" onclick="closeCsvModal()">閉じる</button>
      </div>
      <div class="hint" style="margin-bottom:10px">
        下記のデータをコピーしてExcel等に貼り付けてください
      </div>
      <textarea id="csvText" readonly></textarea>
      <button class="copy-btn" onclick="copyCsv()">コピー</button>
      <div id="copyMsg" class="hint" style="text-align:center; margin-top:8px; color:var(--accent); display:none">
        コピーしました！
      </div>
    </div>
  </div>

  <!-- Lock Overlay -->
  <div id="lockOverlay" class="lock-overlay"></div>
  <div id="lockIndicator" class="lock-indicator">ロック中</div>

<script>
// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('Service Worker registered'))
      .catch(err => console.error('Service Worker registration failed:', err));
  });
}

// PWA Install prompt
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installPrompt.classList.add('show');
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    console.log('PWA installed');
  }
  
  deferredPrompt = null;
  installPrompt.classList.remove('show');
});

// Offline indicator
const offlineIndicator = document.getElementById('offlineIndicator');

window.addEventListener('online', () => {
  offlineIndicator.classList.remove('show');
});

window.addEventListener('offline', () => {
  offlineIndicator.classList.add('show');
});

// Main app logic
(()=>{
  const btn1 = document.getElementById('btn1');
  const btn2 = document.getElementById('btn2');
  const sum1El = document.getElementById('sum1');
  const sum2El = document.getElementById('sum2');
  const sumAllEl = document.getElementById('sumAll');
  const startAtEl = document.getElementById('startAt');
  const exportBtn = document.getElementById('exportCsv');
  const undoBtn = document.getElementById('undoBtn');
  const resetBtn = document.getElementById('resetBtn');
  const fullBtn = document.getElementById('fullBtn');
  const lockBtn = document.getElementById('lockBtn');
  const tbody = document.getElementById('tbody');
  const totalEventsEl = document.getElementById('totalEvents');
  const label1 = document.getElementById('label1');
  const label2 = document.getElementById('label2');
  const name1 = document.getElementById('name1');
  const name2 = document.getElementById('name2');
  const note = document.getElementById('note');
  const soundSel = document.getElementById('soundSel');
  const vibrateSel = document.getElementById('vibrateSel');
  const csvModal = document.getElementById('csvModal');
  const csvText = document.getElementById('csvText');
  const lockOverlay = document.getElementById('lockOverlay');
  const lockIndicator = document.getElementById('lockIndicator');

  let isLocked = false;
  let lockTimer = null;
  
  // Load data from localStorage
  const loadData = () => {
    try {
      const saved = localStorage.getItem('counterData');
      if (saved) {
        const data = JSON.parse(saved);
        return {
          startAt: new Date(data.startAt),
          sum1: data.sum1 || 0,
          sum2: data.sum2 || 0,
          events: data.events || [],
          note: data.note || '',
          name1: data.name1 || '上り',
          name2: data.name2 || '下り',
          soundSel: data.soundSel || 'off',
          vibrateSel: data.vibrateSel || 'off'
        };
      }
    } catch(e) {
      console.error('Failed to load data:', e);
    }
    return {
      startAt: new Date(),
      sum1: 0,
      sum2: 0,
      events: [],
      note: '',
      name1: '上り',
      name2: '下り',
      soundSel: 'off',
      vibrateSel: 'off'
    };
  };

  // Save data to localStorage
  const saveData = () => {
    try {
      const data = {
        startAt: startAt.toISOString(),
        sum1,
        sum2,
        events,
        note: note.value,
        name1: name1.value,
        name2: name2.value,
        soundSel: soundSel.value,
        vibrateSel: vibrateSel.value
      };
      localStorage.setItem('counterData', JSON.stringify(data));
    } catch(e) {
      console.error('Failed to save data:', e);
    }
  };

  // Initialize with loaded data
  const initialData = loadData();
  let startAt = initialData.startAt;
  let sum1 = initialData.sum1;
  let sum2 = initialData.sum2;
  const events = initialData.events;
  
  // Set initial values
  note.value = initialData.note;
  name1.value = initialData.name1;
  name2.value = initialData.name2;
  soundSel.value = initialData.soundSel;
  vibrateSel.value = initialData.vibrateSel;

  const formatISO = (d) => {
    const pad = (n, w=2) => String(n).padStart(w, '0');
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth() + 1);
    const dd = pad(d.getDate());
    const HH = pad(d.getHours());
    const MM = pad(d.getMinutes());
    const SS = pad(d.getSeconds());
    const ms = pad(d.getMilliseconds(), 3);
    const tz = -d.getTimezoneOffset();
    const sign = tz >= 0 ? '+' : '-';
    const tzh = pad(Math.floor(Math.abs(tz) / 60));
    const tzm = pad(Math.abs(tz) % 60);
    return `${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}.${ms}${sign}${tzh}:${tzm}`;
  };

  const formatTime = (isoStr) => {
    const d = new Date(isoStr);
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };

  const playBeep = (() => {
    let ctx;
    return () => {
      if (soundSel.value !== "beep") return;
      try {
        ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          o.disconnect();
          g.disconnect();
        }, 60);
      } catch(e) {}
    };
  })();

  const vibrate = () => {
    if (vibrateSel.value !== "on") return;
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  };

  const render = () => {
    sum1El.textContent = sum1;
    sum2El.textContent = sum2;
    sumAllEl.textContent = sum1 + sum2;
    totalEventsEl.textContent = events.length;
    
    const startDate = new Date(startAt);
    const pad = (n) => String(n).padStart(2, '0');
    startAtEl.textContent = `${pad(startDate.getHours())}:${pad(startDate.getMinutes())}`;

    label1.textContent = name1.value || '方向1';
    label2.textContent = name2.value || '方向2';

    // Recent 10 events
    const last = events.slice(-10).reverse();
    tbody.innerHTML = '';
    last.forEach((ev, idx) => {
      const tr = document.createElement('tr');
      const dirLabel = ev.dir === 1 ? 
        `<span class="pill d1">${name1.value || '方向1'}</span>` : 
        `<span class="pill d2">${name2.value || '方向2'}</span>`;
      
      tr.innerHTML = `
        <td class="right">${events.length - idx}</td>
        <td>${formatTime(ev.tsISO)}</td>
        <td>${dirLabel}</td>
        <td class="right">${ev.sum1 + ev.sum2}</td>
      `;
      tbody.appendChild(tr);
    });
    
    saveData();
  };

  const pushEvent = (dir) => {
    if (isLocked) return;
    
    if (dir === 1) sum1++; 
    else sum2++;
    
    const now = new Date();
    const item = { 
      tsISO: formatISO(now), 
      dir, 
      sum1, 
      sum2, 
      note: note.value.trim() 
    };
    events.push(item);
    
    playBeep();
    vibrate();
    render();
  };

  const undo = () => {
    if (isLocked) return;
    if (!events.length) return;
    
    const last = events.pop();
    if (last.dir === 1) sum1 = Math.max(0, sum1 - 1);
    else sum2 = Math.max(0, sum2 - 1);
    
    render();
  };

  const reset = () => {
    if (isLocked) return;
    if (!confirm('カウントと履歴をすべてリセットしますか？')) return;
    
    events.length = 0;
    sum1 = 0;
    sum2 = 0;
    startAt = new Date();
    render();
  };

  const toggleLock = () => {
    isLocked = !isLocked;
    
    if (isLocked) {
      lockBtn.textContent = 'ロック解除';
      lockBtn.classList.add('lock-active');
      btn1.disabled = true;
      btn2.disabled = true;
      undoBtn.disabled = true;
      resetBtn.disabled = true;
      
      // Show lock indicator briefly
      lockOverlay.classList.add('show');
      lockIndicator.classList.add('show');
      
      clearTimeout(lockTimer);
      lockTimer = setTimeout(() => {
        lockIndicator.classList.remove('show');
      }, 1500);
    } else {
      lockBtn.textContent = 'ロック';
      lockBtn.classList.remove('lock-active');
      btn1.disabled = false;
      btn2.disabled = false;
      undoBtn.disabled = false;
      resetBtn.disabled = false;
      
      lockOverlay.classList.remove('show');
      lockIndicator.classList.remove('show');
    }
  };

  const generateCSV = () => {
    const header = ['index', 'timestamp_local', 'direction', 'label', 'sum_dir1', 'sum_dir2', 'note'];
    const rows = events.map((ev, i) => [
      i + 1,
      ev.tsISO,
      ev.dir,
      ev.dir === 1 ? (name1.value || '方向1') : (name2.value || '方向2'),
      ev.sum1,
      ev.sum2,
      ev.note || ''
    ]);
    
    const csv = [header, ...rows].map(r => r.map(v => {
      const s = String(v).replaceAll('"', '""');
      return /[",\n]/.test(s) ? '"' + s + '"' : s;
    }).join(',')).join('\n');
    
    return csv;
  };

  const showCsvModal = () => {
    const csv = generateCSV();
    csvText.value = csv;
    csvModal.classList.add('show');
  };

  window.closeCsvModal = () => {
    csvModal.classList.remove('show');
    document.getElementById('copyMsg').style.display = 'none';
  };

  window.copyCsv = async () => {
    const text = csvText.value;
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        // Fallback for older browsers
        csvText.select();
        csvText.setSelectionRange(0, 99999);
        document.execCommand('copy');
      }
      
      document.getElementById('copyMsg').style.display = 'block';
      setTimeout(() => {
        document.getElementById('copyMsg').style.display = 'none';
      }, 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
      alert('コピーに失敗しました。テキストを選択して手動でコピーしてください。');
    }
  };

  // Event bindings
  btn1.addEventListener('click', () => pushEvent(1));
  btn2.addEventListener('click', () => pushEvent(2));
  exportBtn.addEventListener('click', showCsvModal);
  undoBtn.addEventListener('click', undo);
  resetBtn.addEventListener('click', reset);
  lockBtn.addEventListener('click', toggleLock);
  fullBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  // Keyboard support for desktop
  if (window.innerWidth > 768) {
    window.addEventListener('keydown', (e) => {
      if (isLocked) return;
      
      if (e.ctrlKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undo();
        return;
      }
      if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
        e.preventDefault();
        pushEvent(1);
      }
      if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'l') {
        e.preventDefault();
        pushEvent(2);
      }
      if (e.key.toLowerCase() === 'f') {
        e.preventDefault();
        fullBtn.click();
      }
    });
  }

  // Label live update with save
  name1.addEventListener('input', () => {
    render();
    saveData();
  });
  name2.addEventListener('input', () => {
    render();
    saveData();
  });
  note.addEventListener('input', () => {
    saveData();
  });
  soundSel.addEventListener('change', () => {
    saveData();
  });
  vibrateSel.addEventListener('change', () => {
    saveData();
  });

  // Prevent accidental navigation
  window.addEventListener('beforeunload', (e) => {
    if (events.length > 0) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // Handle visibility change to save data
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      saveData();
    }
  });

  // Initialize
  render();
})();
</script>
</body>
</html>
